---
title: "`r params$doc_title`"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
description: This report is a template State ED Report. 
  PLEASE Knit it with Parameters!!!
output:
  html_document:
    toc: true
params:
  username:
    label: "NSSP Username: "
    value: ""
    input: text
  password:
    label: "NSSP Password: "
    value: ""
    input: password
  doc_title:
    label: "Title: "
    value: State ED Report Template (NSSP-ESSENCE)
    input: text
  state_abbr:
    label: "Enter State Abbreviation"
    value: "MS"
    input: select
    choices: !r state.abb
  ccdd_categories:
    label: "CCDD Categories"
    value: !r c("CLI CC with CLI DD and Coronavirus DD v1", "CDC Pneumonia CCDD v1", "CDC COVID-Specific DD v1")
    choices: !r fl <- tempfile(fileext =".rds"); download.file(file.path("https://raw.githubusercontent.com", "cdcgov", "Rnssp-rmd-templates", "master", "state_ed_report", "skeleton", "ccdd_cat.rds"), destfile = fl); dplyr::pull(readRDS(fl), ccdd_category)
    input: select
    multiple: yes
  start_date:
    label: "Enter Start Date: "
    value: !r as.Date(paste0(format(Sys.Date(), "%Y-"),"01-01"))
    input: date
  end_date:
    label: "Enter End Date: "
    value: !r lubridate::floor_date(Sys.Date(), unit = "1 week") - 1
    input: date
  ts_type: 
    label: "Time Series Metric"
    value: "Percentages and Counts"
    input: select
    choices: [Percentages, Counts, Percentages and Counts]
  guard_band:
    label: "Guardband: "
    value: 3
    input: numeric
    min: 1
    max: 14
  days_before:
    label: "Days Before: "
    value: 11
    input: numeric
    min: 7
    max: 14
editor_options:
  chunk_output_type: console
---

<style type="text/css">
  .main-container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
</style> 

```{r libraries, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}

library(Rnssp)
library(tidyverse)
library(lubridate)
library(httr)
library(janitor) 
library(DT)
library(kableExtra)
library(purrr)
library(wesanderson)
library(rgdal)
library(ggrepel)
library(ggsci) 
library(ggpubr)
library(ggformula)
library(ggthemes)
library(grid)
library(gridExtra)
library(jsonlite)
library(data.table)
```

```{r set params, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}

endDate <- format(params$end_date, "%d%b%Y")
startDate <- format(params$start_date, "%d%b%Y")

ncat <- length(params$ccdd_categories)
ht_combined <- 3 * ncat
ht_single <- 2 * ncat

```

```{r load NSSP profile, echo=FALSE, message=FALSE, include=FALSE}

myProfile <- Credentials$new(
  username = params$username,
  password = params$password
)

```

```{r, echo = FALSE, eval = FALSE}

load("~/myProfile.rds")

```

```{r set_model_specification, echo = FALSE, message = FALSE, warning = FALSE}

metric <- params$ts_type

if (params$ts_type == "Percentages") {
  reg_family = "binomial"
  trend <- "percent"
  alerts <- "p.values_percent"
} else if (params$ts_type == "Counts") {
  reg_family = "linear"
  trend <- "data_count"
  alerts <- "p.values_counts"
} else {
  reg_family = "binomial and linear"
}

windowed_regression <- function(df, family, geography){
  
  dt <- df %>% 
    as.data.table() 
  
  shift_index <- ifelse(geography == "state", 2, 3)
  
  by_cols <- if (geography == "state") {
    c("ccdd_category")
  } else {
    c("county", "ccdd_category")
  }
  
  if (family == "binomial") {
    dt <- dt %>%
      .[, non_count := all_count - data_count]
    
    shifted.numerator <- setnames(dt[, shift(get("data_count"), (0:daysbefore)), by = by_cols], 
                                  old = shift_index:(daysbefore + shift_index), 
                                  new = paste0("pos", 1:(daysbefore + 1)))
    shifted.denominator <- setnames(dt[, shift(get("non_count"), (0:daysbefore)), by = by_cols],
                                    old = shift_index:(daysbefore + shift_index), 
                                    new = paste0("neg", 1:(daysbefore + 1)))
    
    return_stat <- function(y1, y2, x) {
      mod <- glm(cbind(y1, y2) ~ x, family = "binomial", model = FALSE)
      return(mod$coef[2] / sqrt(vcov(mod)[2, 2]))
    }
    
    res <- cbind(dt[, .SD, .SDcols = "date"], shifted.numerator, shifted.denominator) %>%
      melt(
        id = c("date", by_cols),
        measure = patterns("pos", "neg"), 
        value.name = c("pos", "neg"), 
        variable.name = "date_num"
      ) %>%
      setorderv(cols = c("date", "date_num")) %>%
      .[, date_num := (daysbefore + 1) - as.integer(date_num)] %>%
      .[, threshmet := sum(pos, na.rm = TRUE) >= 10, by = c(by_cols, "date")] %>%
      .[threshmet == TRUE, .("statistic" = return_stat(pos, neg, date_num)), by = c(by_cols, "date")] %>%
      .[, p.value := 2 * pnorm(-abs(statistic))] %>%
      .[, status := fcase(p.value < 0.01 & statistic > 0,"Significantly Increasing", 
                          p.value < 0.01 & statistic < 0, "Significantly Decreasing", 
                          p.value >= 0.01 & statistic > 0, "Not Significant, Positive Slope",
                          p.value >= 0.01 & statistic < 0, "Not Significant, Negative Slope", 
                          is.na(statistic), "Less than 10 Encounters or not Reporting")]
    
    cols <- c("statistic", "p.value", "status")
    
    res_lagged <- res[, c("statistic", "p.value", "status") := shift(.SD, guardband, type = "lag", fill = NA), by = by_cols, .SDcols = cols]
    
    return(res_lagged)
  }
  
  if (family == "linear") {
    
    shifted <- setnames(dt[, shift(get("data_count"), (0:daysbefore)), by = by_cols],
                        old = shift_index:(daysbefore + shift_index),
                        new = paste0("data_count", 1:(daysbefore + 1)))
    
    return_stat <- function(y, x) {
      mod <- lm(y ~ x, model = FALSE)
      return(mod$coef[2] / sqrt(vcov(mod)[2, 2]))
    }
    
    res <- cbind(dt[, .SD, .SDcols = "date"], shifted) %>%
      melt(
        id = c("date", by_cols), 
        measure = patterns("data_count"), 
        value.name = c("data_count"), 
        variable.name = "date_num"
      ) %>%
      setorderv(cols = c("date", "date_num")) %>%
      .[, date_num := (daysbefore + 1) - as.integer(date_num)] %>%
      .[, threshmet := sum(data_count, na.rm = TRUE) >= 10, by = c(by_cols, "date")] %>%
      .[threshmet == TRUE, .("statistic" = return_stat(data_count, date_num)), by = c(by_cols, "date")] %>%
      .[, p.value := 2 * pnorm(-abs(statistic))] %>%
      .[, status := fcase(p.value < 0.01 & statistic > 0,"Significantly Increasing", 
                          p.value < 0.01 & statistic < 0, "Significantly Decreasing", 
                          p.value >= 0.01 & statistic > 0, "Not Significant, Positive Slope",
                          p.value >= 0.01 & statistic < 0, "Not Significant, Negative Slope", 
                          is.na(statistic), "Less than 10 Encounters or not Reporting")]
    
    cols <- c("statistic", "p.value", "status")
    
    res_lagged <- res[, c("statistic", "p.value", "status") := shift(.SD, guardband, type = "lag", fill = NA), by = by_cols, .SDcols = cols]
    
    return(res_lagged)
  }
  
  if (family == "binomial and linear") {
    # > Binomial regression on proportions
    dt <- dt %>%
      .[, non_count := all_count - data_count]
    
    shifted.numerator <- setnames(dt[, shift(get("data_count"), (0:daysbefore)), by = by_cols], 
                                  old = shift_index:(daysbefore + shift_index), 
                                  new = paste0("pos", 1:(daysbefore + 1)))
    shifted.denominator <- setnames(dt[, shift(get("non_count"), (0:daysbefore)), by = by_cols],
                                    old = shift_index:(daysbefore + shift_index), 
                                    new = paste0("neg", 1:(daysbefore + 1)))
    
    return_stat <- function(y1, y2, x) {
      mod <- glm(cbind(y1, y2) ~ x, family = "binomial", model = FALSE)
      return(mod$coef[2] / sqrt(vcov(mod)[2, 2]))
    }
    
    res_binomial <- cbind(dt[, .SD, .SDcols = "date"], shifted.numerator, shifted.denominator) %>%
      melt(
        id = c("date", by_cols),
        measure = patterns("pos", "neg"), 
        value.name = c("pos", "neg"), 
        variable.name = "date_num"
      ) %>%
      setorderv(cols = c("date", "date_num")) %>%
      .[, date_num := (daysbefore + 1) - as.integer(date_num)] %>%
      .[, threshmet := sum(pos, na.rm = TRUE) >= 10, by = c(by_cols, "date")] %>%
      .[threshmet == TRUE, .("statistic" = return_stat(pos, neg, date_num)), by = c(by_cols, "date")] %>%
      .[, p.value := 2 * pnorm(-abs(statistic))] %>%
      .[, status := fcase(p.value < 0.01 & statistic > 0,"Significantly Increasing", 
                          p.value < 0.01 & statistic < 0, "Significantly Decreasing", 
                          p.value >= 0.01 & statistic > 0, "Not Significant, Positive Slope",
                          p.value >= 0.01 & statistic < 0, "Not Significant, Negative Slope", 
                          is.na(statistic), "Less than 10 Encounters or not Reporting")] %>%
      rename(
        statistic_binomial = statistic, 
        p.value_binomial = p.value,
        status_binomial = status
      )
    
    # > Linear regression on counts
    shifted <- setnames(dt[, shift(get("data_count"), (0:daysbefore)), by = by_cols],
                        old = shift_index:(daysbefore + shift_index),
                        new = paste0("data_count", 1:(daysbefore + 1)))
    
    return_stat <- function(y, x) {
      mod <- lm(y ~ x, model = FALSE)
      return(mod$coef[2] / sqrt(vcov(mod)[2, 2]))
    }
    
    res_linear <- cbind(dt[, .SD, .SDcols = "date"], shifted) %>%
      melt(
        id = c("date", by_cols), 
        measure = patterns("data_count"), 
        value.name = c("data_count"), 
        variable.name = "date_num"
      ) %>%
      setorderv(cols = c("date", "date_num")) %>%
      .[, date_num := (daysbefore + 1) - as.integer(date_num)] %>%
      .[, threshmet := sum(data_count, na.rm = TRUE) >= 10, by = c(by_cols, "date")] %>%
      .[threshmet == TRUE, .("statistic" = return_stat(data_count, date_num)), by = c(by_cols, "date")] %>%
      .[, p.value := 2 * pnorm(-abs(statistic))] %>%
      .[, status := fcase(p.value < 0.01 & statistic > 0,"Significantly Increasing", 
                          p.value < 0.01 & statistic < 0, "Significantly Decreasing", 
                          p.value >= 0.01 & statistic > 0, "Not Significant, Positive Slope",
                          p.value >= 0.01 & statistic < 0, "Not Significant, Negative Slope", 
                          is.na(statistic), "Less than 10 Encounters or not Reporting")] %>%
      rename(
        statistic_linear = statistic, 
        p.value_linear = p.value, 
        status_linear = status
      )
    
    # > Combine results for binomial and linear regression 
    if (geography == "state") {
      res <- res_binomial %>%
        merge(res_linear, by = c("ccdd_category", "date")) 
      
      cols <- c("statistic_binomial", "p.value_binomial", "status_binomial", "statistic_linear", "p.value_linear", "status_linear")
      
      res_lagged <- res[, c("statistic_binomial", "p.value_binomial", "status_binomial", "statistic_linear", "p.value_linear", "status_linear") := shift(.SD, guardband, type = "lag", fill = NA), by = by_cols, .SDcols = cols]
      
    }
    if (geography == "county") {
      res <- res_binomial %>%
        merge(res_linear, by = c("county", "ccdd_category", "date"))
      
      cols <- c("statistic_binomial", "p.value_binomial", "status_binomial", "statistic_linear", "p.value_linear", "status_linear")
      
      res_lagged <- res[, c("statistic_binomial", "p.value_binomial", "status_binomial", "statistic_linear", "p.value_linear", "status_linear") := shift(.SD, guardband, type = "lag", fill = NA), by = by_cols, .SDcols = cols]
      
    }
  }
  return(res_lagged)
}

```

```{r set_shapefile, echo = FALSE, warning = FALSE, message = FALSE}

state_fips <- ifelse(nchar(cdlTools::fips(params$state_abbr)) == 1, paste0("0", cdlTools::fips(params$state_abbr)), cdlTools::fips(params$state_abbr))

data("county_sf")
data("state_sf")

us_counties_base <- county_sf %>% 
  st_transform("+proj=longlat +datum=WGS84") 

state_counties <- subset(us_counties_base, STATEFP == state_fips) %>%
  st_as_sf() %>%
  mutate(
    CENTROID = map(geometry, st_centroid),
    COORDS = map(CENTROID, st_coordinates), 
    COORDS_X = map_dbl(COORDS, 1), 
    COORDS_Y = map_dbl(COORDS, 2),
    GEOID = as.character(GEOID)
  )

state_regions <- state_counties %>%
  mutate(
    CENTROID = map(geometry, st_centroid),
    COORDS = map(CENTROID, st_coordinates),
    COORDS_X = map_dbl(COORDS, 1),
    COORDS_Y = map_dbl(COORDS, 2),
    GEOID = as.character(GEOID)
  )

state_name <- state_sf %>% 
  st_set_geometry(NULL) %>% 
  filter(STATEFP == state_fips) %>% 
  select(NAME) %>% 
  pull() %>% 
  as.character()

```

```{r state data pull, echo = FALSE, warning = FALSE, message = FALSE}

guardband <- params$guard_band
daysbefore <- params$days_before

date_marker <- params$end_date - guardband - daysbefore

category_list <- paste0("ccddCategory=", str_replace_all(paste(tolower(params$ccdd_categories), collapse = "&ccddCategory="), " ", "%20"))

geography <- state_sf %>% 
  st_set_geometry(NULL) %>% 
  filter(STATEFP == state_fips) %>% 
  select(STUSPS) %>% 
  pull() %>% 
  as.character() %>% 
  tolower()

url <- paste0("https://essence2.syndromicsurveillance.org/nssp_essence/api/timeSeries?endDate=", endDate, "&geography=", geography, "&percentParam=ccddCategory&datasource=va_hosp&startDate=", startDate, "&medicalGroupingSystem=essencesyndromes&userId=2362&aqtTarget=TimeSeries&", category_list, "&geographySystem=hospitalstate&detector=probrepswitch&timeResolution=daily&hasBeenE=1&stratVal=ccddCategory&multiStratVal=&graphOnly=true&numSeries=3&graphOptions=single&seriesPerYear=false&nonZeroComposite=false&removeZeroSeries=true&startMonth=January&stratVal=ccddCategory&multiStratVal=&graphOnly=true&numSeries=3&graphOptions=single&seriesPerYear=false&startMonth=January&nonZeroComposite=false")

api_data <- myProfile$get_api_data(url) %>%
  pluck("timeSeriesData")

state_data <- api_data %>%
  clean_names() %>%
  select(
    date, 
    ccdd_category = ccdd_category_display,
    data_count = data_count, 
    all_count = all_count, 
    percent = count, 
    alert_percent = color, 
    alert_count = color_data_count, 
    p.value_percent = levels,
    p.value_counts = levels_data_count
  ) %>%
  mutate(date = as.Date(date)) %>%
  mutate_at(c("alert_percent", "alert_count"), ~case_when(
    . %in% c("grey", "blue") ~ "None", 
    . == "red" ~ "Alert", 
    . == "yellow" ~ "Warning"
  )) %>%
  mutate_at(c("alert_percent", "alert_count"), ~factor(., levels = c("Alert", "Warning", "None"))) %>%
  mutate_at(c("p.value_percent", "p.value_counts"), ~as.numeric(.))

```

```{r county data pull, echo = FALSE, message = FALSE, warning = FALSE}

county_fips <- paste0(paste0("&facilityfips=", state_counties$STATEFP, state_counties$COUNTYFP), sep = "", collapse = "")

url <- paste0("https://essence2.syndromicsurveillance.org/nssp_essence/api/timeSeries?endDate=", endDate, county_fips, "&percentParam=ccddCategory&datasource=va_hosp&startDate=", startDate, "&medicalGroupingSystem=essencesyndromes&userId=2362&aqtTarget=TimeSeries&", category_list, "&geographySystem=hospital&detector=probrepswitch&timeResolution=daily&hasBeenE=1&stratVal=ccddCategory&multiStratVal=facilityfips&graphOnly=true&numSeries=3&graphOptions=multipleSmall&seriesPerYear=false&nonZeroComposite=false&removeZeroSeries=false&startMonth=January&stratVal=ccddCategory&multiStratVal=facilityfips&refValues=false&graphOnly=true&numSeries=3&graphOptions=multipleSmall&seriesPerYear=false&startMonth=January&nonZeroComposite=false")

api_data <- myProfile$get_api_data(url) %>%
  pluck("timeSeriesData")

county_data <- api_data %>%
  clean_names() %>%
  select(
    date, 
    county = facilityfips_id,
    county_name = facilityfips_display, 
    ccdd_category = ccdd_category_display,
    data_count = data_count, 
    all_count = all_count, 
    percent = count, 
    alert_percent = color, 
    alert_count = color_data_count, 
    p.value_percent = levels,
    p.value_counts = levels_data_count
  ) %>%
  mutate(
    date = as.Date(date),
    county_name = str_remove_all(county_name, "County")
  ) %>%
  separate(county_name, c("state", "county_name"), sep = " - ") %>%
  mutate(county_name = str_squish(county_name)) %>%
  mutate_at(c("alert_percent", "alert_count"), ~case_when(
    . %in% c("grey", "blue") ~ "None", 
    . == "red" ~ "Alert", 
    . == "yellow" ~ "Warning"
  )) %>%
  mutate_at(c("alert_percent", "alert_count"), ~factor(., levels = c("Alert", "Warning", "None"))) %>%
  mutate_at(c("p.value_percent", "p.value_counts"), ~as.numeric(.))

```

### Introduction

The purpose of this report is to summarize trend classification and ESSENCE alerting for the `r paste(params$ccdd_categories, collapse = ", ")` categories at the state and county level. All trends are reported as percent of daily emergency department visits.

To classify all trends over time, we fit windowed regression models to moving `r params$days_before + 1` day baselines where the statistic and p-value resulting from the statistical test are used to define the last day of the baseline as significantly increasing, significantly decreasing, not significant with positive slope, or not significant with negative slope. To match the current NSSP-ESSENCE implementation of trend classification, binomial regression models are used for time series of percentages, while linear regression models are used for time series of counts. If recent data are pulled, it is best practice to use a 3 day lag to prevent lower counts associated with lags in receiving data from biasing the most recent classification. The significance threshold for p-values is set to 0.01, where trend classification is specified as follows: 

  **Significantly Increasing:** Time term in model is positive and p-value < 0.01
  
  **Significantly Decreasing:** Time term in model is negative and p-value < 0.01 
  
  **Not Significant, Positive Slope:** Time term in model is positive and p-value >= 0.01 
  
  **Not Significant, Negative Slope:** Time term in model is negative and p-value >= 0.01 
  
Note that in instances where the number of encounters for a category in the 12-day time window is less than 10, a model is not fit in order to prevent convergence errors from `glm` and `lm`. In those instances, the trend is classified as "Less than 10 Encounters or Not Reporting". 

To improve identification of stratifications with recent and anomalous increases in syndromic activity, ESSENCE alerting is overlaid on the percentage trends for each county and CCDD category. These alerts correspond to ESSENCE\'s default alerting algorithm, Poisson/EWMA/Regression Switch, with alerting thresholds 0.05 (yellow) and 0.01 (red). Daily stratified alerting indicators and statistics are pulled along with the percentages, numerators, and denominators from the time series data table API (new to ESSENCE as of July 2020). 

### Instructions

This report is included in the `Rnssp` package as a template, and therefore requires users to interactively define input parameters by using the Knit with Parameters option. Parameter selections are available for the following: 

  1. AMC username and password (securely encrypted to a user profile object of class `Credentials`)
  2. State (data are pulled by hospital state from the Facility Location (Full Details) data source)
  3. CCDD Categories - currently includes all existing CCDD Categories available in ESSENCE. Users may select as many categories as they choose. The default categories are CLI CC with CLI DD and Coronavirus DD v1, CDC Pneumonia CCDD v1, and CDC COVID-Specific DD v1.
  4. Start and end date of query
  5. Time series type - percentages, counts, or percentages *and* counts (default)
  6. Guard band - number of days the date in consideration is separated from the baseline (default is 3)
  7. Days Before - length of baseline - 1 (default is 12 - 1 = 11)

```{r state analysis, echo = FALSE, warning = FALSE, message = FALSE}

max_date <- max(state_data$date)
min_date <- min(state_data$date)

if (reg_family %in% c("binomial", "linear")) {
  state_trends_analyzed <- state_data %>%
    filter(date >= min_date + daysbefore) %>%
    left_join(
      state_data %>%
        windowed_regression(family = reg_family, geography = "state") %>%
        as.data.frame() %>%
        arrange(date), 
      by = c("date", "ccdd_category")
    ) %>%
    arrange(ccdd_category, date) %>%
    mutate(
      status = ifelse(is.na(status), "Less than 10 Encounters or not Reporting", status),
      status = factor(status, levels = c("Significantly Increasing", 
                                         "Not Significant, Positive Slope",
                                         "Not Significant, Negative Slope",
                                         "Significantly Decreasing", 
                                         "Less than 10 Encounters or not Reporting"))
    ) 
  
}

if (reg_family == "binomial and linear") {
  state_trends_analyzed <- state_data %>%
    filter(date >= min_date + daysbefore) %>%
    left_join(
      state_data %>%
        windowed_regression(family = reg_family, geography = "state") %>%
        as.data.frame() %>%
        arrange(date), 
      by = c("date", "ccdd_category")
    ) %>%
    arrange(ccdd_category, date) %>%
    mutate_at(.vars = c("status_binomial", "status_linear"), ~ifelse(is.na(.), "Less than 10 Encounters or not Reporting", .)) %>%
    mutate_at(.vars = c("status_binomial", "status_linear"), ~factor(., levels = c("Significantly Increasing", 
                                                                                   "Not Significant, Positive Slope",
                                                                                   "Not Significant, Negative Slope",
                                                                                   "Significantly Decreasing", 
                                                                                   "Less than 10 Encounters or not Reporting"))) 
  
}

state_trends_combined <- bind_rows(
  state_trends_analyzed %>%
    select(
      date:percent,
      alert = alert_count, 
      p.value = p.value_linear,
      status = status_linear 
    ) %>%
    group_by(ccdd_category) %>%
    mutate(seven_day = zoo::rollmean(data_count, 7, align = "right", fill = NA)) %>%
    ungroup() %>%
    mutate(
      time_series = data_count, 
      trend = "counts"
    ),
  state_trends_analyzed %>%
    select(
      date:percent,
      alert = alert_percent, 
      p.value = p.value_binomial, 
      status = status_binomial
    ) %>%
    group_by(ccdd_category) %>%
    mutate(
      seven_day = slide(
        .x = tibble(data_count, all_count), 
        .f = function(.x) {
          (sum(.x$data_count) / sum(.x$all_count)) * 100
        },
        .before = 6, 
        .complete = FALSE
      ),
      seven_day = as.numeric(seven_day)
    ) %>%
    mutate(
      trend = "percentages",
      time_series = percent
    )
) %>%
  filter(!is.na(seven_day))

```

```{r county analysis, echo = FALSE, warning = FALSE, message = FALSE}

max_date <- max(county_data$date)
min_date <- min(county_data$date)

if (reg_family %in% c("binomial", "linear")) {
  county_trends_analyzed <- county_data %>%
    filter(date >= min_date + daysbefore) %>%
    left_join(
      county_data %>%
        windowed_regression(family = reg_family, geography = "county") %>%
        as.data.frame() %>%
        arrange(date), 
      by = c("county", "date", "ccdd_category")
    ) %>%
    arrange(ccdd_category, county, date) %>%
    mutate(
      status = ifelse(is.na(status), "Less than 10 Encounters or not Reporting", status),
      status = factor(status, levels = c("Significantly Increasing", 
                                         "Not Significant, Positive Slope",
                                         "Not Significant, Negative Slope",
                                         "Significantly Decreasing", 
                                         "Less than 10 Encounters or not Reporting"))
    ) 
  
}

if (reg_family == "binomial and linear") {
  county_trends_analyzed <- county_data %>%
    filter(date >= min_date + daysbefore) %>%
    left_join(
      county_data %>%
        windowed_regression(family = reg_family, geography = "county") %>%
        as.data.frame() %>%
        arrange(date), 
      by = c("county", "date", "ccdd_category")
    ) %>%
    arrange(ccdd_category, county, date) %>%
    mutate_at(.vars = c("status_binomial", "status_linear"), ~ifelse(is.na(.), "Less than 10 Encounters or not Reporting", .)) %>%
    mutate_at(.vars = c("status_binomial", "status_linear"), ~factor(., levels = c("Significantly Increasing", 
                                                                                   "Not Significant, Positive Slope",
                                                                                   "Not Significant, Negative Slope",
                                                                                   "Significantly Decreasing", 
                                                                                   "Less than 10 Encounters or not Reporting"))) 
}

county_trends_combined <- bind_rows(
  county_trends_analyzed %>%
    select(
      date:percent,
      alert = alert_count, 
      p.value = p.value_linear,
      status = status_linear 
    ) %>%
    group_by(county, ccdd_category) %>%
    mutate(seven_day = zoo::rollmean(data_count, 7, align = "right", fill = NA)) %>%
    ungroup() %>%
    mutate(
      trend = "counts",
      time_series = data_count
    ) %>%
    right_join(state_counties, by = c("county" = "GEOID")),
  county_trends_analyzed %>%
    select(
      date:percent,
      alert = alert_percent, 
      p.value = p.value_binomial, 
      status = status_binomial
    ) %>%
    group_by(county, ccdd_category) %>%
    mutate(
      seven_day = slide(
        .x = tibble(data_count, all_count), 
        .f = function(.x) {
          (sum(.x$data_count) / sum(.x$all_count)) * 100
        },
        .before = 6, 
        .complete = FALSE
      ),
      seven_day = as.numeric(seven_day),
      seven_day = ifelse(is.nan(seven_day), 0, seven_day)
    ) %>%
    mutate(
      trend = "percentages",
      time_series = percent
    ) %>%
    right_join(state_counties, by = c("county" = "GEOID"))
) %>%
  ungroup() %>%
  filter(!is.na(seven_day))

```

### County Level Maps 

```{r county maps, echo = FALSE, warning = FALSE, message = FALSE}

wes.pal <- wes_palette(n = 5, name = "Darjeeling1")
pal <- c(wes.pal[c(1, 4, 3, 2)], "#FFFFFF")

county_trends_recent <- county_trends_combined %>%
  filter(date == max(date))

trends_sf <- county_trends_recent %>%
  st_as_sf() %>%
  mutate(
    nudge_x = 0, 
    nudge_y = 0, 
    status = factor(status, levels = c(
      "Significantly Increasing", 
      "Not Significant, Positive Slope",
      "Not Significant, Negative Slope",
      "Significantly Decreasing", 
      "Less than 10 Encounters or not Reporting"
    ))
  ) %>%
  mutate(
    category_label = ccdd_category,
    trend_label = trend
  ) %>%
  nest(data = -c(ccdd_category, trend)) %>%
  mutate(
    county_map = map(.x = data, .f = function(.x) {
      
      if (unique(.x$trend_label) == "counts") {
        .date <- format(max(.x$date), "%B %d, %Y")
        .subtitle <- "Trajectory of daily emergency department encounters are classified by fitting moving linear regression models to 12-day baselines. \nDays with a p-value less than 0.01 are classified as having significant, recent change, where the sign of the time coefficient \ndetermines the direction of change."
        
        plot <- ggplot() + 
          geom_sf(data = .x, aes(fill = status), color = "black") + 
          scale_fill_manual(values = pal, drop = FALSE) + 
          labs(fill = "Trend Classification (Counts)") + 
          geom_text_repel(
            data = .x,
            mapping = aes(
              x = COORDS_X,
              y = COORDS_Y,
              label = NAME),
            nudge_x = .x$nudge_x,
            nudge_y = .x$nudge_y,
            size = 3,
            min.segment.length = 0,
            point.padding = NA,
            segment.color = "grey20"
          ) +
          theme_classic() +
          labs(
            title = paste0("Recent Trajectory in Daily Counts for ", unique(.x$category_label), ": ", .date),
            subtitle = .subtitle
          ) + 
      theme(axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(), axis.title.y=element_blank(), legend.justification="top",
            panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank(),
            plot.margin=unit(c(0, 0, 0, 0), "cm"), plot.caption = element_text(hjust = 0, lineheight=1.1),
            plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
            legend.key = element_rect(colour = "black"),
            legend.box.margin=margin(t=0, r=0, b=0, l=15))
      }
      
      if (unique(.x$trend_label) == "percentages") {
        .date <- format(max(.x$date), "%B %d, %Y")
        .subtitle <- "Trajectory of daily emergency department encounters are classified by fitting moving binomial regression models to 12-day baselines. \nDays with a p-value less than 0.01 are classified as having significant, recent change, where the sign of the time coefficient \ndetermines the direction of change."
        
        plot <- ggplot() + 
          geom_sf(data = .x, aes(fill = status), color = "black") + 
          scale_fill_manual(values = pal, drop = FALSE) + 
          labs(fill = "Trend Classification (Percentages)") + 
          geom_text_repel(
            data = .x,
            mapping = aes(
              x = COORDS_X,
              y = COORDS_Y,
              label = NAME),
            nudge_x = .x$nudge_x,
            nudge_y = .x$nudge_y,
            size = 3,
            min.segment.length = 0,
            point.padding = NA,
            segment.color = "grey20"
          ) +
          theme_classic() +
          labs(
            title = paste0("Recent Trajectory in Daily Percentages for ", unique(.x$category_label), ": ", .date),
            subtitle = .subtitle
          ) + 
      theme(axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(), axis.title.y=element_blank(), legend.justification="top",
            panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank(),
            plot.margin=unit(c(0, 0, 0, 0), "cm"), plot.caption = element_text(hjust = 0, lineheight=1.1),
            plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
            legend.key = element_rect(colour = "black"),
            legend.box.margin=margin(t=0, r=0, b=0, l=15))
      }
      
      plot
      
    })
  ) %>%
  select(-data) %>%
  pivot_wider(names_from = trend, values_from = county_map)

```

```{r percent_countss, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8}

if(params$ts_type == "Percentages and Counts"){
  for (i in 1:nrow(trends_sf)) {
    grid.arrange(trends_sf$counts[[i]])
    grid.arrange(trends_sf$percentages[[i]])
  }
}

```

```{r percent, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8}

if(params$ts_type == "Percentages"){
  for (i in 1:nrow(trends_sf)) {
    grid.arrange(trends_sf$percentages[[i]])
  }
}

```

```{r counts, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8}

if(params$ts_type == "Counts"){
  for (i in 1:nrow(trends_sf)) {
    grid.arrange(trends_sf$counts[[i]])
  }
}

```

### `r paste("Plots for State-level Trajectory Based on", metric)` 

Trajectory of daily emergency department encounters are classified by fitting moving regression models to 12-day baselines. Binomial regression is used for visit proportions, while linear regression is used for counts. Days with a p-value less than 0.01 are classified as having significant, recent change, where the sign of the time coefficient determines the direction of change. ESSENCE anomalies and are indicated by red points and are based on the default EWMA/Regression switch algorithm. Smoothed lines represent 7-day moving averages.

```{r state level trajectory, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 13, fig.height = ht_combined, fig.align = "center"}

pal <- c(wes.pal[c(1, 4, 2, 3)], "#DDDDDD")

state_traj <- state_trends_combined %>%
  group_by(ccdd_category, trend) %>%
  mutate(
    p.value = format(p.value, digits = 2, scientific = TRUE), 
    trend = ifelse(trend == "counts", "Counts", "Percentages"),
    category_label = paste0(ccdd_category, " ", trend, "\n", last(status), ": ", last(p.value))
  ) %>%
  ungroup() 

date_range <- paste(format(min(state_traj$date), "%B %d, %Y"), "to", format(max(state_traj$date), "%B %d, %Y"))

if(params$ts_type == "Percentages and Counts"){
  
  ggplot(data = state_traj) + 
    geom_line(aes(x = date, y = time_series), stat = "identity", color = "#005EAA", size = 0.7, alpha = 0.5) +
    geom_line(aes(x = date, y = seven_day), color = "#005EAA", size = 0.7) +
    geom_vline(xintercept = date_marker, linetype = "dashed") +
    geom_segment(aes(x = date, xend = max(date), y = 0, yend = 0, color = status), size = 3) + 
    geom_point(data = subset(state_traj, alert == "Alert"), aes(x = date, y = time_series), color = "red", size = 2) +
    geom_point(data = subset(state_traj, alert == "Warning"), aes(x = date, y = time_series), color = "yellow", size = 2) +
    scale_x_date(date_breaks = "30 day", date_labels = "%b %d", expand = c(0, 0)) + 
    scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
    expand_limits(y = 0) + 
    scale_color_manual(values = pal, name = "Trajectory", drop = FALSE) + 
    scale_fill_manual(values = c("red", "yellow"), name = "") +
    labs(
      x = "Date", 
      y = "Counts (First Column) and Percentages (Second Column)",
      title = paste0(state_name, " - State-level Trajectory for Selected CCDD Categories: ", date_range), 
      subtitle = "Trajectory of daily emergency department encounters are classified by fitting moving regression models to 12-day baselines. \nBinomial regression is used for visit proportions, while linear regression is used for counts. Days with a p-value less than \n0.01 are classified as having significant, recent change, where the sign of the time coefficient determines the direction of change. \nESSENCE anomalies and are indicated by red points and are based on the default EWMA/Regression switch algorithm. \nSmoothed lines represent 7-day moving averages"
    ) +
    theme_few() + 
    theme(
      strip.text = element_text(size = 10, face = "bold", hjust = 0), 
      panel.background = element_rect(fill="white"),
      axis.text.x = element_text(color = "black", size = 10),
      axis.text.y = element_text(color = "black", size = 12),
      plot.title = element_text(face = "bold",hjust = 0),
      plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
      panel.border = element_rect(color = "black", fill = NA, size = 0.9), 
      legend.position = "top",
      legend.text = element_text(size = 10),
      legend.title = element_blank(),
      panel.spacing.x = unit(2.0, "lines")
    ) +
    facet_wrap(~category_label, scales = "free", ncol = 2, dir = "h") 
  
}

```

```{r state level trajectory2, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 13, fig.height = ht_single - 1}

if (params$ts_type == "Percentages"){
  
  state_traj_percent <- state_traj %>%
    filter(trend == "Percentages")
  
  ggplot(data = state_traj_percent) + 
    geom_line(aes(x = date, y = time_series), stat = "identity", color = "#005EAA", size = 1.0, alpha = 0.5) +
    geom_line(aes(x = date, y = seven_day), color = "#005EAA", size = 1.0) +
    geom_vline(xintercept = date_marker, linetype = "dashed") +
    geom_segment(aes(x = date, xend = max(date), y = 0, yend = 0, color = status), size = 3) + 
    geom_point(data = subset(state_traj_percent, alert == "Alert"), aes(x = date, y = time_series), color = "red", size = 2) +
    geom_point(data = subset(state_traj_percent, alert == "Warning"), aes(x = date, y = time_series), color = "yellow", size = 2) +
    scale_x_date(date_breaks = "15 day", date_labels = "%b %d", expand = c(0, 0)) + 
    scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
    expand_limits(y = 0) + 
    scale_color_manual(values = pal, name = "Trajectory", drop = FALSE) + 
    scale_fill_manual(values = c("red", "yellow"), name = "") +
    labs(
      x = "Date", 
      y = "Percentages",
      title = paste0(state_name, " - State-level Trajectory for Selected CCDD Categories: ", date_range), 
      subtitle = "Trajectory of daily emergency department encounters are classified by fitting moving binomial regression models to 12-day baselines. \nDays with a p-value less than 0.01 are classified as having significant, recent change, where the sign of the time coefficient \ndetermines the direction of change. ESSENCE anomalies and are indicated by red points and are based on the default EWMA/Regression \nswitch algorithm. Smoothed lines represent 7-day moving averages"
    ) +
    theme_few() + 
    theme(
      strip.text = element_text(size = 10, face = "bold", hjust = 0), 
      panel.background = element_rect(fill="white"),
      axis.text.x = element_text(color = "black", size = 10),
      axis.text.y = element_text(color = "black", size = 12),
      plot.title = element_text(face = "bold",hjust = 0),
      plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
      panel.border = element_rect(color = "black", fill = NA, size = 0.9), 
      legend.position = "top",
      legend.text = element_text(size = 10)
    ) +
    facet_wrap(~category_label, scales = "free", ncol = 3) 
  
}

```

```{r state level trajectory3, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 13, fig.height = ht_single - 1}

if (params$ts_type == "Counts"){
  
  state_traj_count <- state_traj %>%
    filter(trend == "Counts")
  
  ggplot(data = state_traj_count) + 
    geom_line(aes(x = date, y = time_series), stat = "identity", color = "#005EAA", size = 1.0, alpha = 0.5) +
    geom_line(aes(x = date, y = seven_day), color = "#005EAA", size = 1.0) +
    geom_vline(xintercept = date_marker, linetype = "dashed") +
    geom_segment(aes(x = date, xend = max(date), y = 0, yend = 0, color = status), size = 3) + 
    geom_point(data = subset(state_traj_count, alert == "Alert"), aes(x = date, y = time_series), color = "red", size = 2) +
    geom_point(data = subset(state_traj_count, alert == "Warning"), aes(x = date, y = time_series), color = "yellow", size = 2) +
    scale_x_date(date_breaks = "15 day", date_labels = "%b %d", expand = c(0, 0)) + 
    scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
    expand_limits(y = 0) + 
    scale_color_manual(values = pal, name = "Trajectory") + 
    scale_fill_manual(values = c("red", "yellow"), name = "", drop = FALSE) +
    labs(
      x = "Date", 
      y = "Counts",
      title = paste0(state_name, " - State-level Trajectory for Selected CCDD Categories: ", date_range), 
      subtitle = "Trajectory of daily emergency department encounters are classified by fitting moving linear regression models to 12-day baselines. \nDays with a p-value less than 0.01 are classified as having significant, recent change, where the sign of the time coefficient \ndetermines the direction of change. ESSENCE anomalies and are indicated by red points and are based on the default EWMA/Regression \nswitch algorithm. Smoothed lines represent 7-day moving averages"
    ) +
    theme_few() + 
    theme(
      strip.text = element_text(size = 10, face = "bold", hjust = 0), 
      panel.background = element_rect(fill="white"),
      axis.text.x = element_text(color = "black", size = 10),
      axis.text.y = element_text(color = "black", size = 12),
      plot.title = element_text(face = "bold",hjust = 0),
      plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
      panel.border = element_rect(color = "black", fill = NA, size = 0.9),
      legend.position = "top",
      legend.text = element_text(size = 10)
    ) +
    facet_wrap(~category_label, scales = "free", ncol = 3) 
  
}

```

### `r paste("Plots for County-level Trajectory Based on", metric)` 

```{r county level trajectory, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 13, fig.height = ht_single - 2}

cpal <- c("#005EAA", "#497D0C", "#BB4D00")

geography_timeseries <- bind_rows(
  county_trends_combined %>%
    filter(trend == "percentages"),
  state_trends_combined %>%
    filter(trend == "percentages")
) %>%
  mutate(
    county = ifelse(is.na(county), "State-wide", county), 
    county_name = ifelse(is.na(county_name), "State-wide", county_name)
  ) %>%
  ungroup() %>%
  fill(state, .direction = "down") %>%
  group_by(county) %>%
  filter(!sum(data_count) == 0) %>%
  ungroup() 

ggplot(data = geography_timeseries) + 
  geom_line(aes(x = date, y = seven_day, group = county), size = 0.7, color = "gray80") + 
  geom_line(data = subset(geography_timeseries, county == "State-wide"), aes(x = date, y = seven_day, group = state), color = cpal[1], size = 1.0) + 
  scale_x_date(date_breaks = "30 day", date_labels = "%b %d") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
  expand_limits(y = 0) + 
  facet_wrap(~ccdd_category, ncol = 3) +
  theme_few() + 
  labs(
    title = "County and State-Level 7-day Moving Averages Over Time - Percent of Emergency Department Visits", 
    subtitle = paste0("Data pulled from ", date_range, ". Gray lines represent trends for reporting counties."),
    x = "Date", 
    y = "7-day Moving Average - Percent of ED Visits"
  ) +
  theme(
    strip.text = element_text(size = 12, face = "bold", hjust = 0), 
    panel.background = element_rect(fill="white"),
    axis.text.x = element_text(color = "black", size = 10),
    axis.text.y = element_text(color = "black", size = 12),
    plot.title = element_text(face = "bold",hjust = 0),
    plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.9), 
    legend.position = "top",
    legend.text = element_text(size = 10),
    legend.title = element_blank()
  )

```

```{r county level trajectory2, echo = FALSE, message = FALSE, warning = FALSE}

county_traj <- county_trends_combined %>%
  group_by(ccdd_category, trend, county) %>%
  mutate(
    p.value = format(p.value, digits = 2, scientific = TRUE), 
    trend = ifelse(trend == "counts", "Counts", "Percentages"),
    category_label = paste0(ccdd_category, " ", trend, "\n", last(status), ": ", last(p.value))
  ) %>%
  ungroup()

date_range <- paste(format(min(county_traj$date), "%B %d, %Y"), "to", format(max(county_traj$date), "%B %d, %Y"))

```

```{r county level trajectory_percent_counts, echo = FALSE, message = FALSE, warning = FALSE}

if(params$ts_type == "Percentages and Counts"){

county_traj_plots <- county_traj %>%
  group_by(county, trend) %>%
  nest(data = -county) %>%
  mutate(
    plot = map(.x = data, .f = function(.x) {

      ggplot(data = .x) + 
        geom_line(aes(x = date, y = time_series), stat = "identity", color = "#005EAA", size = 0.7, alpha = 0.5) +
        geom_line(aes(x = date, y = seven_day), color = "#005EAA", size = 0.7) +
        geom_vline(xintercept = date_marker, linetype = "dashed") +
        geom_segment(aes(x = date, xend = max(date), y = 0, yend = 0, color = status), size = 3) + 
        geom_point(data = subset(.x, alert == "Alert"), aes(x = date, y = time_series), color = "red", size = 2) +
        geom_point(data = subset(.x, alert == "Warning"), aes(x = date, y = time_series), color = "yellow", size = 2) +
        scale_x_date(date_breaks = "30 day", date_labels = "%b %d", expand = c(0, 0)) + 
        scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
        expand_limits(y = 0) + 
        scale_color_manual(values = pal, name = "", drop = FALSE) + 
        scale_fill_manual(values = c("red", "yellow"), name = "") +
        labs(
          x = "Date", 
          y = "Counts (First Column) and Percentages (Second Column)",
          subtitle = paste0("County-level Trajectory for Selected CCDD Categories: ", date_range), 
          title = paste(unique(.x$county_name), "County")
        ) +
        theme_few() + 
        theme(
          strip.text = element_text(size = 10, face = "bold", hjust = 0), 
          panel.background = element_rect(fill="white"),
          axis.text.x = element_text(color = "black", size = 10),
          axis.text.y = element_text(color = "black", size = 12),
          plot.title = element_text(face = "bold",hjust = 0),
          plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
          panel.border = element_rect(color = "black", fill = NA, size = 0.9), 
          legend.position = "top",
          legend.text = element_text(size = 10),
          legend.title = element_blank(),
          panel.spacing.x = unit(2.0, "lines")
        ) +
        facet_wrap(~category_label, scales = "free", ncol = 2, dir = "h", drop = FALSE) 
      
    })
  )

}

```

```{r county level trajectory_percent, echo = FALSE, message = FALSE, warning = FALSE}

if(params$ts_type == "Percentages"){

county_traj_plots <- county_traj %>%
  filter(trend == "Percentages") %>%
  nest(data = -county) %>%
  mutate(
    plot = map(.x = data, .f = function(.x) {
      
      ggplot(data = .x) + 
        geom_line(aes(x = date, y = time_series), stat = "identity", color = "#005EAA", size = 0.7, alpha = 0.5) +
        geom_line(aes(x = date, y = seven_day), color = "#005EAA", size = 0.7) +
        geom_vline(xintercept = date_marker, linetype = "dashed") +
        geom_segment(aes(x = date, xend = max(date), y = 0, yend = 0, color = status), size = 3) + 
        geom_point(data = subset(.x, alert == "Alert"), aes(x = date, y = time_series), color = "red", size = 2) +
        geom_point(data = subset(.x, alert == "Warning"), aes(x = date, y = time_series), color = "yellow", size = 2) +
        scale_x_date(date_breaks = "30 day", date_labels = "%b %d", expand = c(0, 0)) + 
        scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
        expand_limits(y = 0) + 
        scale_color_manual(values = pal, name = "", drop = FALSE) + 
        scale_fill_manual(values = c("red", "yellow"), name = "") +
        labs(
          x = "Date", 
          y = "Percent",
          subtitle = paste0("County-level Trajectory for Selected CCDD Categories, ", unique(.x$county_name), " County: ", date_range), 
          title = paste(unique(.x$county_name), "County")
        ) +
        theme_few() + 
        theme(
          strip.text = element_text(size = 10, face = "bold", hjust = 0), 
          panel.background = element_rect(fill="white"),
          axis.text.x = element_text(color = "black", size = 10),
          axis.text.y = element_text(color = "black", size = 12),
          plot.title = element_text(face = "bold",hjust = 0),
          plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
          panel.border = element_rect(color = "black", fill = NA, size = 0.9), 
          legend.position = "top",
          legend.text = element_text(size = 10),
          legend.title = element_blank()
        ) +
        facet_wrap(~category_label, scales = "free", ncol = 2, dir = "h") 
      
    })
  )

}

```

```{rcounty level trajectory_count, echo = FALSE, message = FALSE, warning = FALSE}

if(params$ts_type == "Counts"){

county_traj_plots <- county_traj %>%
  filter(trend == "Counts") %>%
  nest(data = -county) %>%
  mutate(
    plot = map(.x = data, .f = function(.x) {
      
      ggplot(data = .x) + 
        geom_line(aes(x = date, y = time_series), stat = "identity", color = "#005EAA", size = 0.7, alpha = 0.5) +
        geom_line(aes(x = date, y = seven_day), color = "#005EAA", size = 0.7) +
        geom_vline(xintercept = date_marker, linetype = "dashed") +
        geom_segment(aes(x = date, xend = max(date), y = 0, yend = 0, color = status), size = 3) + 
        geom_point(data = subset(.x, alert == "Alert"), aes(x = date, y = time_series), color = "red", size = 2) +
        geom_point(data = subset(.x, alert == "Warning"), aes(x = date, y = time_series), color = "yellow", size = 2) +
        scale_x_date(date_breaks = "30 day", date_labels = "%b %d", expand = c(0, 0)) + 
        scale_color_manual(values = pal, name = "Trajectory") + 
        scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) + 
        expand_limits(y = 0) + 
        scale_fill_manual(values = c("red", "yellow"), name = "") +
        labs(
          x = "Date", 
          y = "Counts",
          subtitle = paste0("County-level Trajectory for Selected CCDD Categories, ", unique(.x$county_name), " County: ", date_range), 
          title = paste(unique(.x$county_name), "County")
        ) + 
        theme_few() + 
        theme(
          strip.text = element_text(size = 10, face = "bold", hjust = 0), 
          panel.background = element_rect(fill="white"),
          axis.text.x = element_text(color = "black", size = 10),
          axis.text.y = element_text(color = "black", size = 12),
          plot.title = element_text(face = "bold",hjust = 0),
          plot.subtitle = element_text(size = 11, hjust = 0, face = "italic"),
          panel.border = element_rect(color = "black", fill = NA, size = 0.9), 
          legend.position = "top",
          legend.text = element_text(size = 10),
          legend.title = element_blank()
        ) +
        facet_wrap(~category_label, scales = "free", ncol = 2, dir = "h") 
      
    })
  )

}

```

```{r county_traj_plots_percent_counts, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 13, fig.height = ht_combined, fig.align = "center"}

if(params$ts_type == "Percentages and Counts"){
  for (i in 1:nrow(county_traj_plots)) {
    grid.arrange(county_traj_plots$plot[[i]])
  }
}

```

```{r county_traj_plots_percent, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 13, fig.height = 5, fig.align = "center"}

if(params$ts_type == "Percentages"){
  for (i in 1:nrow(county_traj_plots)) {
    grid.arrange(county_traj_plots$plot[[i]])
  }
}

```

```{r county_traj_plots_counts, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 13, fig.height = 5, fig.align = "center"}

if(params$ts_type == "Counts"){
  for (i in 1:nrow(county_traj_plots)) {
    grid.arrange(county_traj_plots$counts[[i]])
  }
}

```

### County Summary Table

```{r county summary table, echo = FALSE, warning = FALSE, message = FALSE}

county_summary <- county_trends_combined %>%
  filter(date == max(date)) %>%
  select(
    county_name, 
    county,
    ccdd_category, 
    trend, 
    status, 
    p.value,
    alert
  ) %>%
  mutate(trend = ifelse(trend == "counts", "Counts", "Percentages")) %>%
  filter(!grepl("not Reporting", status)) %>%
  mutate(p.value = format(p.value, digits = 2, scientific = TRUE)) %>%
  arrange(county_name, ccdd_category) %>%
  select(
    `County Name` = county_name, 
    `FIPS` = county, 
    `CCDD Category` = ccdd_category, 
    `Time Series Metric` = trend, 
    `Trend Classification` = status, 
    `p-value` = p.value, 
    `Temporal Anomaly` = alert
  ) 

county_summary %>%
  datatable(class = "cell-border stripe",
            style = "bootstrap", 
            filter = "top", 
            extensions = "Buttons",
            options = list(
              dom = "Bfrtip",
              buttons = c("csv", "excel", "pdf"),
              scrollY = 400,
              pageLength = 50)
  ) %>%
  formatStyle(
    "Trend Classification",
    target = "row", 
    backgroundColor = styleEqual(c("Significantly Increasing", "Significantly Decreasing"), c(pal[[1]], pal[[3]]))
  )

```